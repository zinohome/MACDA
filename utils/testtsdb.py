#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#  #
#  Copyright (C) 2021 ZinoHome, Inc. All Rights Reserved
#  #
#  @Time    : 2021
#  @Author  : Zhang Jun
#  @Email   : ibmzhangjun@139.com
#  @Software: MACDA
import traceback
import weakref
import psycopg2
from core.settings import settings
from utils.log import log as log

CONNECTION = "postgres://postgres:passw0rd@192.168.32.160:5432/postgres"

class Cached(type):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.__cache = weakref.WeakValueDictionary()

    def __call__(self, *args):
        if args in self.__cache:
            return self.__cache[args]
        else:
            obj = super().__call__(*args)
            self.__cache[args] = obj
            return obj
class TSutil(metaclass=Cached):
    def __init__(self):
        log.debug('Connect to timescaledb uri [ %s ]' % CONNECTION)
        self.conn = psycopg2.connect(CONNECTION)
        try:
            log.debug("Check tsdb table ...")
            create_pro_table = "CREATE TABLE IF NOT EXISTS pro_macda (msg_calc_dvc_time TIMESTAMPTZ NOT NULL, msg_calc_parse_time TEXT NOT NULL, msg_calc_dvc_no TEXT NOT NULL, dvc_i_inner_temp DOUBLE PRECISION NULL, dvc_i_outer_temp DOUBLE PRECISION NULL, dvc_i_set_temp DOUBLE PRECISION NULL, dvc_i_seat_temp DOUBLE PRECISION NULL, dvc_i_veh_temp DOUBLE PRECISION NULL, dvc_w_passen_load DOUBLE PRECISION NULL, dvc_w_op_mode_u1 DOUBLE PRECISION NULL, dvc_i_fat_u1 DOUBLE PRECISION NULL, dvc_i_rat_u1 DOUBLE PRECISION NULL, dvc_i_sat_u11 DOUBLE PRECISION NULL, dvc_i_sat_u12 DOUBLE PRECISION NULL, dvc_i_dft_u11 DOUBLE PRECISION NULL, dvc_i_dft_u12 DOUBLE PRECISION NULL, dvc_w_freq_u11 DOUBLE PRECISION NULL, dvc_w_crnt_u11 DOUBLE PRECISION NULL, dvc_w_vol_u11 DOUBLE PRECISION NULL, dvc_w_freq_u12 DOUBLE PRECISION NULL, dvc_w_crnt_u12 DOUBLE PRECISION NULL, dvc_w_vol_u12 DOUBLE PRECISION NULL, dvc_i_suck_temp_u11 DOUBLE PRECISION NULL, dvc_i_suck_pres_u11 DOUBLE PRECISION NULL, dvc_i_sup_heat_u11 DOUBLE PRECISION NULL, dvc_i_eev_pos_u11 DOUBLE PRECISION NULL, dvc_i_suck_temp_u12 DOUBLE PRECISION NULL, dvc_i_suck_pres_u12 DOUBLE PRECISION NULL, dvc_i_sup_heat_u12 DOUBLE PRECISION NULL, dvc_i_eev_pos_u12 DOUBLE PRECISION NULL, dvc_w_pos_fad_u1 DOUBLE PRECISION NULL, dvc_w_op_mode_u2 DOUBLE PRECISION NULL, dvc_i_fat_u2 DOUBLE PRECISION NULL, dvc_i_rat_u2 DOUBLE PRECISION NULL, dvc_i_sat_u21 DOUBLE PRECISION NULL, dvc_i_sat_u22 DOUBLE PRECISION NULL, dvc_i_dft_u21 DOUBLE PRECISION NULL, dvc_i_dft_u22 DOUBLE PRECISION NULL, dvc_w_freq_u21 DOUBLE PRECISION NULL, dvc_w_crnt_u21 DOUBLE PRECISION NULL, dvc_w_vol_u21 DOUBLE PRECISION NULL, dvc_w_freq_u22 DOUBLE PRECISION NULL, dvc_w_crnt_u22 DOUBLE PRECISION NULL, dvc_w_vol_u22 DOUBLE PRECISION NULL, dvc_i_suck_temp_u21 DOUBLE PRECISION NULL, dvc_i_suck_pres_u21 DOUBLE PRECISION NULL, dvc_i_sup_heat_u21 DOUBLE PRECISION NULL, dvc_i_eev_pos_u21 DOUBLE PRECISION NULL, dvc_i_suck_temp_u22 DOUBLE PRECISION NULL, dvc_i_suck_pres_u22 DOUBLE PRECISION NULL, dvc_i_sup_heat_u22 DOUBLE PRECISION NULL, dvc_i_eev_pos_u22 DOUBLE PRECISION NULL, dvc_w_pos_fad_u2 DOUBLE PRECISION NULL, dvc_cfbk_comp_u11 DOUBLE PRECISION NULL, dvc_cfbk_comp_u12 DOUBLE PRECISION NULL, dvc_cfbk_comp_u21 DOUBLE PRECISION NULL, dvc_cfbk_comp_u22 DOUBLE PRECISION NULL, dvc_cfbk_ef_u1 DOUBLE PRECISION NULL, dvc_cfbk_ef_u2 DOUBLE PRECISION NULL, dvc_cfbk_cf_u1 DOUBLE PRECISION NULL, dvc_cfbk_cf_u2 DOUBLE PRECISION NULL, dvc_cfbk_pwr DOUBLE PRECISION NULL, dvc_bocflt_ef_u11 DOUBLE PRECISION NULL, dvc_bocflt_ef_u12 DOUBLE PRECISION NULL, dvc_bocflt_cf_u11 DOUBLE PRECISION NULL, dvc_bocflt_cf_u12 DOUBLE PRECISION NULL, dvc_bflt_vfd_u11 DOUBLE PRECISION NULL, dvc_blpflt_comp_u11 DOUBLE PRECISION NULL, dvc_bscflt_comp_u11 DOUBLE PRECISION NULL, dvc_bflt_vfd_u12 DOUBLE PRECISION NULL, dvc_blpflt_comp_u12 DOUBLE PRECISION NULL, dvc_bscflt_comp_u12 DOUBLE PRECISION NULL, dvc_bflt_eev_u11 DOUBLE PRECISION NULL, dvc_bflt_eev_u12 DOUBLE PRECISION NULL, dvc_bflt_fad_u1 DOUBLE PRECISION NULL, dvc_bflt_rad_u1 DOUBLE PRECISION NULL, dvc_bflt_airclean_u1 DOUBLE PRECISION NULL, dvc_bflt_frstemp_u1 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u11 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u12 DOUBLE PRECISION NULL, dvc_bflt_rnttemp_u1 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u11 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u12 DOUBLE PRECISION NULL, dvc_bocflt_ef_u21 DOUBLE PRECISION NULL, dvc_bocflt_ef_u22 DOUBLE PRECISION NULL, dvc_bocflt_cf_u21 DOUBLE PRECISION NULL, dvc_bocflt_cf_u22 DOUBLE PRECISION NULL, dvc_bflt_vfd_u21 DOUBLE PRECISION NULL, dvc_blpflt_comp_u21 DOUBLE PRECISION NULL, dvc_bscflt_comp_u21 DOUBLE PRECISION NULL, dvc_bflt_vfd_u22 DOUBLE PRECISION NULL, dvc_blpflt_comp_u22 DOUBLE PRECISION NULL, dvc_bscflt_comp_u22 DOUBLE PRECISION NULL, dvc_bflt_eev_u21 DOUBLE PRECISION NULL, dvc_bflt_eev_u22 DOUBLE PRECISION NULL, dvc_bflt_fad_u2 DOUBLE PRECISION NULL, dvc_bflt_rad_u2 DOUBLE PRECISION NULL, dvc_bflt_airclean_u2 DOUBLE PRECISION NULL, dvc_bflt_frstemp_u2 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u21 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u22 DOUBLE PRECISION NULL, dvc_bflt_rnttemp_u2 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u21 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u22 DOUBLE PRECISION NULL, dvc_bflt_vehtemp DOUBLE PRECISION NULL, dvc_bflt_seattemp DOUBLE PRECISION NULL, dvc_bflt_emergivt DOUBLE PRECISION NULL, dvc_bflt_mvbbus DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u11 DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u12 DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u21 DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u22 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u11 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u12 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u21 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u22 DOUBLE PRECISION NULL, dvc_bmcbflt_pwr_u1 DOUBLE PRECISION NULL, dvc_bmcbflt_pwr_u2 DOUBLE PRECISION NULL, dvc_blplockflt_u11 DOUBLE PRECISION NULL, dvc_blplockflt_u12 DOUBLE PRECISION NULL, dvc_blplockflt_u21 DOUBLE PRECISION NULL, dvc_blplockflt_u22 DOUBLE PRECISION NULL, dvc_bsclockflt_u11 DOUBLE PRECISION NULL, dvc_bsclockflt_u12 DOUBLE PRECISION NULL, dvc_bsclockflt_u21 DOUBLE PRECISION NULL, dvc_bsclockflt_u22 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u11 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u12 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u21 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u22 DOUBLE PRECISION NULL, dvc_beevlockflt_u11 DOUBLE PRECISION NULL, dvc_beevlockflt_u12 DOUBLE PRECISION NULL, dvc_beevlockflt_u21 DOUBLE PRECISION NULL, dvc_beevlockflt_u22 DOUBLE PRECISION NULL, dvc_cft_code_u1 DOUBLE PRECISION NULL, dvc_cft_code_u2 DOUBLE PRECISION NULL, dvc_dwoptime_emergivt DOUBLE PRECISION NULL, dvc_dwopcount_emergivt DOUBLE PRECISION NULL, dvc_dwoptime_ef_u1 DOUBLE PRECISION NULL, dvc_dwoptime_cf_u1 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u11 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u12 DOUBLE PRECISION NULL, dvc_dwopcount_ef_u1 DOUBLE PRECISION NULL, dvc_dwopcount_cf_u1 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u11 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u12 DOUBLE PRECISION NULL, dvc_dwopcount_fad_u1 DOUBLE PRECISION NULL, dvc_dwopcount_rad_u1 DOUBLE PRECISION NULL, dvc_dwoptime_ef_u2 DOUBLE PRECISION NULL, dvc_dwoptime_cf_u2 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u21 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u22 DOUBLE PRECISION NULL, dvc_dwopcount_ef_u2 DOUBLE PRECISION NULL, dvc_dwopcount_cf_u2 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u21 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u22 DOUBLE PRECISION NULL, dvc_dwopcount_fad_u2 DOUBLE PRECISION NULL, dvc_dwopcount_rad_u2 DOUBLE PRECISION NULL);"
            create_dev_table = "CREATE TABLE IF NOT EXISTS dev_macda (msg_calc_dvc_time TEXT NOT NULL, msg_calc_parse_time TIMESTAMPTZ NOT NULL, msg_calc_dvc_no TEXT NOT NULL, dvc_i_inner_temp DOUBLE PRECISION NULL, dvc_i_outer_temp DOUBLE PRECISION NULL, dvc_i_set_temp DOUBLE PRECISION NULL, dvc_i_seat_temp DOUBLE PRECISION NULL, dvc_i_veh_temp DOUBLE PRECISION NULL, dvc_w_passen_load DOUBLE PRECISION NULL, dvc_w_op_mode_u1 DOUBLE PRECISION NULL, dvc_i_fat_u1 DOUBLE PRECISION NULL, dvc_i_rat_u1 DOUBLE PRECISION NULL, dvc_i_sat_u11 DOUBLE PRECISION NULL, dvc_i_sat_u12 DOUBLE PRECISION NULL, dvc_i_dft_u11 DOUBLE PRECISION NULL, dvc_i_dft_u12 DOUBLE PRECISION NULL, dvc_w_freq_u11 DOUBLE PRECISION NULL, dvc_w_crnt_u11 DOUBLE PRECISION NULL, dvc_w_vol_u11 DOUBLE PRECISION NULL, dvc_w_freq_u12 DOUBLE PRECISION NULL, dvc_w_crnt_u12 DOUBLE PRECISION NULL, dvc_w_vol_u12 DOUBLE PRECISION NULL, dvc_i_suck_temp_u11 DOUBLE PRECISION NULL, dvc_i_suck_pres_u11 DOUBLE PRECISION NULL, dvc_i_sup_heat_u11 DOUBLE PRECISION NULL, dvc_i_eev_pos_u11 DOUBLE PRECISION NULL, dvc_i_suck_temp_u12 DOUBLE PRECISION NULL, dvc_i_suck_pres_u12 DOUBLE PRECISION NULL, dvc_i_sup_heat_u12 DOUBLE PRECISION NULL, dvc_i_eev_pos_u12 DOUBLE PRECISION NULL, dvc_w_pos_fad_u1 DOUBLE PRECISION NULL, dvc_w_op_mode_u2 DOUBLE PRECISION NULL, dvc_i_fat_u2 DOUBLE PRECISION NULL, dvc_i_rat_u2 DOUBLE PRECISION NULL, dvc_i_sat_u21 DOUBLE PRECISION NULL, dvc_i_sat_u22 DOUBLE PRECISION NULL, dvc_i_dft_u21 DOUBLE PRECISION NULL, dvc_i_dft_u22 DOUBLE PRECISION NULL, dvc_w_freq_u21 DOUBLE PRECISION NULL, dvc_w_crnt_u21 DOUBLE PRECISION NULL, dvc_w_vol_u21 DOUBLE PRECISION NULL, dvc_w_freq_u22 DOUBLE PRECISION NULL, dvc_w_crnt_u22 DOUBLE PRECISION NULL, dvc_w_vol_u22 DOUBLE PRECISION NULL, dvc_i_suck_temp_u21 DOUBLE PRECISION NULL, dvc_i_suck_pres_u21 DOUBLE PRECISION NULL, dvc_i_sup_heat_u21 DOUBLE PRECISION NULL, dvc_i_eev_pos_u21 DOUBLE PRECISION NULL, dvc_i_suck_temp_u22 DOUBLE PRECISION NULL, dvc_i_suck_pres_u22 DOUBLE PRECISION NULL, dvc_i_sup_heat_u22 DOUBLE PRECISION NULL, dvc_i_eev_pos_u22 DOUBLE PRECISION NULL, dvc_w_pos_fad_u2 DOUBLE PRECISION NULL, dvc_cfbk_comp_u11 DOUBLE PRECISION NULL, dvc_cfbk_comp_u12 DOUBLE PRECISION NULL, dvc_cfbk_comp_u21 DOUBLE PRECISION NULL, dvc_cfbk_comp_u22 DOUBLE PRECISION NULL, dvc_cfbk_ef_u1 DOUBLE PRECISION NULL, dvc_cfbk_ef_u2 DOUBLE PRECISION NULL, dvc_cfbk_cf_u1 DOUBLE PRECISION NULL, dvc_cfbk_cf_u2 DOUBLE PRECISION NULL, dvc_cfbk_pwr DOUBLE PRECISION NULL, dvc_bocflt_ef_u11 DOUBLE PRECISION NULL, dvc_bocflt_ef_u12 DOUBLE PRECISION NULL, dvc_bocflt_cf_u11 DOUBLE PRECISION NULL, dvc_bocflt_cf_u12 DOUBLE PRECISION NULL, dvc_bflt_vfd_u11 DOUBLE PRECISION NULL, dvc_blpflt_comp_u11 DOUBLE PRECISION NULL, dvc_bscflt_comp_u11 DOUBLE PRECISION NULL, dvc_bflt_vfd_u12 DOUBLE PRECISION NULL, dvc_blpflt_comp_u12 DOUBLE PRECISION NULL, dvc_bscflt_comp_u12 DOUBLE PRECISION NULL, dvc_bflt_eev_u11 DOUBLE PRECISION NULL, dvc_bflt_eev_u12 DOUBLE PRECISION NULL, dvc_bflt_fad_u1 DOUBLE PRECISION NULL, dvc_bflt_rad_u1 DOUBLE PRECISION NULL, dvc_bflt_airclean_u1 DOUBLE PRECISION NULL, dvc_bflt_frstemp_u1 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u11 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u12 DOUBLE PRECISION NULL, dvc_bflt_rnttemp_u1 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u11 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u12 DOUBLE PRECISION NULL, dvc_bocflt_ef_u21 DOUBLE PRECISION NULL, dvc_bocflt_ef_u22 DOUBLE PRECISION NULL, dvc_bocflt_cf_u21 DOUBLE PRECISION NULL, dvc_bocflt_cf_u22 DOUBLE PRECISION NULL, dvc_bflt_vfd_u21 DOUBLE PRECISION NULL, dvc_blpflt_comp_u21 DOUBLE PRECISION NULL, dvc_bscflt_comp_u21 DOUBLE PRECISION NULL, dvc_bflt_vfd_u22 DOUBLE PRECISION NULL, dvc_blpflt_comp_u22 DOUBLE PRECISION NULL, dvc_bscflt_comp_u22 DOUBLE PRECISION NULL, dvc_bflt_eev_u21 DOUBLE PRECISION NULL, dvc_bflt_eev_u22 DOUBLE PRECISION NULL, dvc_bflt_fad_u2 DOUBLE PRECISION NULL, dvc_bflt_rad_u2 DOUBLE PRECISION NULL, dvc_bflt_airclean_u2 DOUBLE PRECISION NULL, dvc_bflt_frstemp_u2 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u21 DOUBLE PRECISION NULL, dvc_bflt_splytemp_u22 DOUBLE PRECISION NULL, dvc_bflt_rnttemp_u2 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u21 DOUBLE PRECISION NULL, dvc_bflt_dfstemp_u22 DOUBLE PRECISION NULL, dvc_bflt_vehtemp DOUBLE PRECISION NULL, dvc_bflt_seattemp DOUBLE PRECISION NULL, dvc_bflt_emergivt DOUBLE PRECISION NULL, dvc_bflt_mvbbus DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u11 DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u12 DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u21 DOUBLE PRECISION NULL, dvc_bcomuflt_vfd_u22 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u11 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u12 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u21 DOUBLE PRECISION NULL, dvc_bcomuflt_eev_u22 DOUBLE PRECISION NULL, dvc_bmcbflt_pwr_u1 DOUBLE PRECISION NULL, dvc_bmcbflt_pwr_u2 DOUBLE PRECISION NULL, dvc_blplockflt_u11 DOUBLE PRECISION NULL, dvc_blplockflt_u12 DOUBLE PRECISION NULL, dvc_blplockflt_u21 DOUBLE PRECISION NULL, dvc_blplockflt_u22 DOUBLE PRECISION NULL, dvc_bsclockflt_u11 DOUBLE PRECISION NULL, dvc_bsclockflt_u12 DOUBLE PRECISION NULL, dvc_bsclockflt_u21 DOUBLE PRECISION NULL, dvc_bsclockflt_u22 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u11 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u12 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u21 DOUBLE PRECISION NULL, dvc_bvfdlockflt_u22 DOUBLE PRECISION NULL, dvc_beevlockflt_u11 DOUBLE PRECISION NULL, dvc_beevlockflt_u12 DOUBLE PRECISION NULL, dvc_beevlockflt_u21 DOUBLE PRECISION NULL, dvc_beevlockflt_u22 DOUBLE PRECISION NULL, dvc_cft_code_u1 DOUBLE PRECISION NULL, dvc_cft_code_u2 DOUBLE PRECISION NULL, dvc_dwoptime_emergivt DOUBLE PRECISION NULL, dvc_dwopcount_emergivt DOUBLE PRECISION NULL, dvc_dwoptime_ef_u1 DOUBLE PRECISION NULL, dvc_dwoptime_cf_u1 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u11 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u12 DOUBLE PRECISION NULL, dvc_dwopcount_ef_u1 DOUBLE PRECISION NULL, dvc_dwopcount_cf_u1 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u11 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u12 DOUBLE PRECISION NULL, dvc_dwopcount_fad_u1 DOUBLE PRECISION NULL, dvc_dwopcount_rad_u1 DOUBLE PRECISION NULL, dvc_dwoptime_ef_u2 DOUBLE PRECISION NULL, dvc_dwoptime_cf_u2 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u21 DOUBLE PRECISION NULL, dvc_dwoptime_comp_u22 DOUBLE PRECISION NULL, dvc_dwopcount_ef_u2 DOUBLE PRECISION NULL, dvc_dwopcount_cf_u2 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u21 DOUBLE PRECISION NULL, dvc_dwopcount_cp_u22 DOUBLE PRECISION NULL, dvc_dwopcount_fad_u2 DOUBLE PRECISION NULL, dvc_dwopcount_rad_u2 DOUBLE PRECISION NULL);"
            cur = self.conn.cursor()
            cur.execute(create_pro_table)
            cur.execute(create_dev_table)
            cur.execute("SELECT create_hypertable('pro_macda', 'msg_calc_dvc_time', chunk_time_interval => 86400000000, if_not_exists => TRUE);")
            cur.execute("SELECT create_hypertable('dev_macda', 'msg_calc_parse_time', chunk_time_interval => 86400000000, if_not_exists => TRUE);")
            self.conn.commit()
            cur.close()
            log.debug("Check tsdb table ... Success !")
        except Exception as exp:
            log.error('Exception at dbmeta.gen_schema() %s ' % exp)
            traceback.print_exc()



if __name__ == '__main__':
    tu = TSutil()
